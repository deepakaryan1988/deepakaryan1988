name: Update README – Blog Posts
on:
  schedule:
    - cron: "0 2 * * *"  # Daily at 02:00 UTC (off-peak hours)
  workflow_dispatch:
permissions:
  contents: write
jobs:
  update-readme-with-blog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Wait random delay to avoid conflicts
        run: sleep $((RANDOM % 300))  # Random delay 0-5 minutes
        
      - name: Update README with latest blog posts from Hashnode
        uses: Sachin-chaurasiya/hashnode-blog-action@v0.0.9
        with:
          HASHNODE_PUBLICATION_NAME: 'debugdeploygrow.hashnode.dev'
          POST_COUNT: 5
          FORMAT: 'list'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Check for blog posts and handle empty section
        run: |
          # Check if blog posts were successfully added
          if grep -q "<!-- HASHNODE_BLOG:START -->" README.md; then
            # Check if there's content between the markers
            content=$(sed -n '/<!-- HASHNODE_BLOG:START -->/,/<!-- HASHNODE_BLOG:END -->/p' README.md | grep -v "<!-- HASHNODE_BLOG:" | grep -v "^$" || true)
            if [ -n "$content" ] && [ "$content" != "" ]; then
              echo "✅ Blog posts found - section will be visible"
            else
              echo "❌ No blog posts found - hiding section"
              # Remove the entire blog posts section
              sed -i '/## 📰 Recent Blog Posts/,/---/d' README.md
              # Add the --- back if it was removed
              if ! tail -n1 README.md | grep -q "^---$"; then
                echo "---" >> README.md
              fi
              # Commit the change
              git config --global user.email "action@github.com"
              git config --global user.name "GitHub Action"
              git add README.md
              git commit -m "🔧 Hide empty blog posts section" || echo "No changes to commit"
              git push || echo "Nothing to push"
            fi
          fi
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "Hashnode blog workflow failed."
          echo "Check if username 'debugdeploygrow' is correct and publication is accessible."
          echo "Blog section will be hidden until Hashnode API recovers."

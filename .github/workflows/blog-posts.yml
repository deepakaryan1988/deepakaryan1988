name: Update README ‚Äì Blog Posts
on:
  schedule:
    - cron: "0 2 * * *"  # Daily at 02:00 UTC (off-peak hours)
  workflow_dispatch:
permissions:
  contents: write
jobs:
  update-readme-with-blog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Wait random delay to avoid conflicts
        run: sleep $((RANDOM % 300))  # Random delay 0-5 minutes
        
      - name: Update README with latest blog posts
        uses: gautamkrishnar/blog-post-workflow@master
        with:
          max_post_count: 5
          feed_list: "https://debugdeploygrow.hashnode.dev/rss.xml,https://hashnode-feed-proxy.vercel.app/api/rss?url=debugdeploygrow"
          template: "‚Ä¢ [$title]($url) - $newDate"
          commit_message: "üìù Update blog posts in README"
          retry_count: 8
          retry_wait_time: 300  # 5 minutes between retries
          user_agent: "BlogPostWorkflow/1.0 (+https://github.com/gautamkrishnar/blog-post-workflow)"
          accept_header: "application/rss+xml, application/xml;q=0.9, */*;q=0.8"
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          disable_sort: false
          filter_dates: false
          
      - name: Hide empty blog section
        run: |
          # Check if blog posts were successfully fetched
          if grep -q "<!-- BLOG-POST-LIST:START -->" README.md; then
            # Check if there's content between the markers
            if ! grep -Pzo "<!-- BLOG-POST-LIST:START -->\s*\n\s*<!-- BLOG-POST-LIST:END -->" README.md > /dev/null 2>&1; then
              echo "‚úÖ Blog posts found - section will be visible"
            else
              echo "‚ùå No blog posts found - hiding section"
              # Remove the entire blog posts section
              sed -i '/## üì∞ Recent Blog Posts/,/---/d' README.md
              # Add the --- back if it was removed
              if ! tail -n1 README.md | grep -q "^---$"; then
                echo "---" >> README.md
              fi
              # Commit the change
              git config --global user.email "action@github.com"
              git config --global user.name "GitHub Action"
              git add README.md
              git commit -m "üîß Hide empty blog posts section" || echo "No changes to commit"
              git push || echo "Nothing to push"
            fi
          fi
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "Primary workflow failed. Backup workflow will run in 30 minutes."
          echo "RSS URL returned 429 or other error. Check Hashnode status."
